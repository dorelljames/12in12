---
import Base from "../layouts/Base.astro";
const title = "Sign in";

// Get query parameters for messages
const searchParams = Astro.url.searchParams;
const success = searchParams.get("success");
const error = searchParams.get("error");
---

<Base title={title}>
  <main class="flex-1 flex flex-col gap-4 items-center p-4 justify-center">
    <section class="w-full max-w-md">
      <h1 class="font-semibold text-2xl text-zinc-100 w-full mb-12">
        {title}
      </h1>

      {
        success && (
          <div class="mb-6 p-4 rounded-md bg-green-50 border border-green-200 text-green-800">
            <p>Check your email for the magic link to sign in!</p>
          </div>
        )
      }

      {
        error && (
          <div class="mb-6 p-4 rounded-md bg-red-50 border border-red-200 text-red-800">
            <p>{decodeURIComponent(error)}</p>
          </div>
        )
      }

      <form
        id="signin-form"
        action="/api/auth/signin"
        method="post"
        class="grid grid-cols-1 gap-3 w-full"
      >
        <div class="grid grid-cols-1 gap-2">
          <label for="email" class="font-medium text-zinc-300 text-sm"
            >Email</label
          >
          <input
            id="email"
            type="email"
            name="email"
            placeholder="your@email.com"
            required
            class="rounded-md py-2 px-4 bg-zinc-50 border border-zinc-300 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-60"
          />
        </div>
        <button
          id="submit-btn"
          type="submit"
          class="dark:bg-zinc-100 bg-zinc-900 border-zinc-900 py-2.5 border dark:border-zinc-100 rounded-md mt-2 dark:text-zinc-900 text-zinc-100 font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-zinc-900 disabled:opacity-50 disabled:cursor-not-allowed"
          >Send Me Magic Link</button
        >
      </form>
    </section>
  </main>
</Base>

<script>
  // Handle code parameter from magic link
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");

  if (code) {
    window.location.href = `/api/auth/callback?code=${encodeURIComponent(code)}`;
  }

  // Handle form submission
  const form = document.getElementById("signin-form");
  const submitBtn = document.getElementById("submit-btn");

  if (form && submitBtn) {
    form.addEventListener("submit", (e) => {
      submitBtn.disabled = true;
      submitBtn.textContent = "Sending Magic Link...";
    });
  }
</script>
